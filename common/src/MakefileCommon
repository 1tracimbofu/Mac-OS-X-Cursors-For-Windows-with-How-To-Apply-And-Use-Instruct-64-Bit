#--- Default build will be release. Can be overiden passing BUILD_TYPE = debug as a parameter
BUILD_TYPE = Release

ifeq ($(BUILD_TYPE), Release)
	BUILD_DEFS += -DNDEBUG
endif

OBJDIR = ../$(BUILD_TYPE)
BINDIR = ../bin

LCC = c:/gbdk/bin/lcc.exe
SDCC = c:/gbdk/bin/sdcc.exe
MOD2GBT = c:/gbdk/bin/mod2gbt.exe
BGB = c:/gbdk/bin/bgb/bgb.exe

ifneq ($(strip $(N_BANKS)),)
	LFLAGS_NBANKS = -Wl-yt1 -Wl-yo$(N_BANKS)
endif

CFLAGS = -DUSE_SFR_FOR_REG $(BUILD_DEFS) -I..\include -I..\..\common\include
#-Wa-l -Wl-m -Wl-j 
LFLAGS = -DUSE_SFR_FOR_REG $(LFLAGS_NBANKS)
CC = $(LCC)

current_dir = $(shell pwd)

ASMS      = $(foreach dir,.,$(notdir $(wildcard $(dir)/*.s)))
CLASSES   = $(foreach dir,.,$(notdir $(wildcard $(dir)/*.c)))
RESOURCES = $(foreach dir,./resources,$(notdir $(wildcard $(dir)/*.c)))
MUSICS    = $(foreach dir,./music,$(notdir $(wildcard $(dir)/*.mod)))
OBJS = $(CLASSES:%.c=$(OBJDIR)/%.o) $(RESOURCES:%.c=$(OBJDIR)/%.o) $(ASMS:%.s=$(OBJDIR)/%.o) $(MUSICS:%.mod=$(OBJDIR)/%.mod.o)


#until I can find a way to create a .lib I'll be linking the.o files from my common library
COMMON_OBJS = $(wildcard ../../common/Release/*.o)

$(BINDIR):
	mkdir $(BINDIR)
	
$(OBJDIR):
	mkdir $(OBJDIR)

$(OBJDIR)/%.o: %.s
	$(CC) $(CFLAGS) $(filter -Wf-bo%, $(subst .b,-Wf-bo,$(suffix $(<:%.s=%)))) -c -o $@ $<

$(OBJDIR)/%.o: %.c
	$(CC) $(CFLAGS) $(filter -Wf-bo%, $(subst .b,-Wf-bo,$(suffix $(<:%.c=%)))) -c -o $@ $<

$(OBJDIR)/%.o: resources/%.c
	sed -i "s/unsigned char/const unsigned  char/g" $<
	$(CC) $(CFLAGS) $(filter -Wf-bo%, $(subst .b,-Wf-bo,$(suffix $(<:%.c=%)))) -c -o $@ $<

$(OBJDIR)/%.mod.o: music/%.mod
	$(MOD2GBT) $< $(basename $(basename $(notdir $<)))_mod -c $(subst .b,,$(suffix $(<:%.mod=%)))
	mv output.c $(OBJDIR)/music_tmp.c
	$(CC) $(CFLAGS) -c -o $@ $(OBJDIR)/music_tmp.c
	
$(BINDIR)/$(PROJECT_NAME).gb: $(OBJDIR) $(BINDIR) $(OBJS) $(COMMON_OBJS)
	$(CC) $(LFLAGS) -o $(BINDIR)/$(PROJECT_NAME).gb $(OBJS) $(COMMON_OBJS)

build_lib: $(OBJDIR) $(OBJS)

build_gb: $(BINDIR)/$(PROJECT_NAME).gb

clean:
	rm -rf $(BINDIR)/*.gb
	rm -rf $(OBJDIR)/*.o
	rm -rf .map
	rm -rf .lst
	
run: $(BINDIR)/$(PROJECT_NAME).gb
	$(BGB) $(BINDIR)/$(PROJECT_NAME).gb
	